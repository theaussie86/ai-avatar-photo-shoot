---
phase: 08-ai-suggestions-quality-feedback
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app/actions/video-prompt-actions.ts
  - hooks/use-ai-suggestions.ts
  - components/avatar-creator/ActionSuggestions.tsx
  - components/avatar-creator/VideoPromptPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 3-5 AI-generated suggestions based on image content"
    - "AI suggestions appear after fixed suggestions with sparkle indicator"
    - "AI suggestions are in German (consistent with app language)"
    - "User can click AI suggestion to add to instruction textarea"
    - "Loading state shown while AI analyzes image"
  artifacts:
    - path: "app/actions/video-prompt-actions.ts"
      provides: "getAISuggestionsForImageAction server action"
      exports: ["getAISuggestionsForImageAction"]
    - path: "hooks/use-ai-suggestions.ts"
      provides: "React Query hook for fetching AI suggestions"
      exports: ["useAISuggestions"]
    - path: "components/avatar-creator/ActionSuggestions.tsx"
      provides: "Extended with AI suggestions and sparkle icon"
    - path: "components/avatar-creator/VideoPromptPanel.tsx"
      provides: "Integration of AI suggestions hook"
  key_links:
    - from: "hooks/use-ai-suggestions.ts"
      to: "getAISuggestionsForImageAction"
      via: "useQuery calling server action"
      pattern: "useQuery.*getAISuggestionsForImageAction"
    - from: "VideoPromptPanel.tsx"
      to: "useAISuggestions"
      via: "Hook call with imageId"
      pattern: "useAISuggestions.*imageId"
    - from: "ActionSuggestions.tsx"
      to: "aiSuggestions prop"
      via: "Rendering AI chips with sparkle"
      pattern: "aiSuggestions.*Sparkles"
---

<objective>
Add AI-generated suggestions based on image analysis using Gemini, displayed alongside fixed suggestions with a sparkle indicator.

Purpose: Provide contextual action suggestions that are relevant to the specific image content (e.g., "Blick zur Kamera richten" if subject is looking away), helping users create more tailored video prompts.

Output: Server action for AI suggestion generation, React Query hook, extended ActionSuggestions component with AI chips and sparkle icon.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-suggestions-quality-feedback/08-CONTEXT.md
@.planning/phases/08-ai-suggestions-quality-feedback/08-01-SUMMARY.md

@app/actions/video-prompt-actions.ts
@hooks/use-video-prompts.ts
@components/avatar-creator/ActionSuggestions.tsx
@components/avatar-creator/VideoPromptPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAISuggestionsForImageAction server action</name>
  <files>app/actions/video-prompt-actions.ts</files>
  <action>
Add a new server action to video-prompt-actions.ts that analyzes an image and returns contextual suggestions.

Function signature:
```typescript
export async function getAISuggestionsForImageAction(imageId: string): Promise<string[]>
```

Implementation steps:
1. Authenticate user (same pattern as generateVideoPromptAction)
2. Get API key from profiles table, decrypt
3. Verify image ownership via collection relationship
4. Fetch image from storage (same pattern as generateVideoPromptAction)
5. Upload to Gemini Files API
6. Call Gemini with a system prompt requesting 3-5 German action suggestions based on image content

System prompt for suggestions:
```
Du bist ein Experte für Video-Animationen. Analysiere dieses Bild einer Person und schlage 3-5 kurze Aktionen vor, die diese Person in einem animierten Video machen könnte.

Regeln:
- Antworte NUR mit einer JSON-Liste von Strings
- Jeder Vorschlag maximal 3-4 Wörter auf Deutsch
- Berücksichtige die Pose, Blickrichtung und den Kontext im Bild
- Vorschläge sollten natürlich und umsetzbar sein

Beispiel-Format: ["nach links schauen", "Augen schließen", "Kopf neigen"]
```

7. Parse JSON response, validate it's an array of strings
8. Clean up Gemini file
9. Return array of suggestions (3-5 items)

Error handling:
- If parsing fails, return empty array []
- Log errors but don't throw (suggestions are non-critical)
- Timeout/quota errors return empty array
  </action>
  <verify>
    - getAISuggestionsForImageAction exported from video-prompt-actions.ts
    - Function authenticates user and verifies image ownership
    - Gemini call includes image analysis
    - Returns string[] (3-5 suggestions or empty on error)
  </verify>
  <done>
Server action analyzes image via Gemini and returns 3-5 German action suggestions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useAISuggestions hook</name>
  <files>hooks/use-ai-suggestions.ts</files>
  <action>
Create React Query hook for fetching AI suggestions.

Implementation:
```typescript
import { useQuery } from "@tanstack/react-query"
import { getAISuggestionsForImageAction } from "@/app/actions/video-prompt-actions"

export function useAISuggestions(imageId: string | null) {
  return useQuery({
    queryKey: ["ai-suggestions", imageId],
    queryFn: () => getAISuggestionsForImageAction(imageId!),
    enabled: !!imageId,
    staleTime: 5 * 60 * 1000,  // 5 minutes - suggestions don't need frequent refresh
    retry: 1,  // Only retry once, suggestions are non-critical
  })
}
```

Key settings:
- staleTime 5 minutes (image content doesn't change, suggestions stable)
- Single retry (fail fast, suggestions are enhancement not core)
- Enabled only when imageId present
  </action>
  <verify>
    - File exists at hooks/use-ai-suggestions.ts
    - Hook exports useAISuggestions
    - Uses React Query with appropriate staleTime
    - Calls getAISuggestionsForImageAction
  </verify>
  <done>
useAISuggestions hook provides cached AI suggestions for an image
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend ActionSuggestions with AI suggestions and sparkle icon</name>
  <files>components/avatar-creator/ActionSuggestions.tsx</files>
  <action>
Update ActionSuggestions component to display AI suggestions alongside fixed suggestions.

New props:
- aiSuggestions?: string[] - AI-generated suggestions
- isLoadingAI?: boolean - loading state for AI suggestions

UI changes:
1. Add Sparkles icon import from lucide-react
2. Fixed suggestions section remains as-is (header: "Aktions-Vorschläge")
3. Add AI suggestions section below fixed suggestions:
   - Header: "KI-Vorschläge" with small Sparkles icon (h-3 w-3 text-purple-400)
   - Only render if aiSuggestions has items OR isLoadingAI is true
   - Loading state: Show 3 skeleton chips (animate-pulse, w-20 h-6 rounded-full)
   - Same chip styling as fixed suggestions
   - AI chips include small Sparkles icon (h-3 w-3) before text

Layout:
- Keep single flex-wrap container or separate by section
- AI suggestions distinctly grouped below fixed
- Sparkle icon provides subtle distinction per CONTEXT.md

Toggle behavior remains the same - both fixed and AI suggestions use same selectedSuggestions state.
  </action>
  <verify>
    - Sparkles icon imported from lucide-react
    - aiSuggestions and isLoadingAI props added
    - AI suggestions section renders with sparkle icon
    - Loading state shows skeleton chips
    - Both fixed and AI suggestions toggle into same selection state
  </verify>
  <done>
ActionSuggestions displays AI suggestions with sparkle indicator and loading state
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate AI suggestions into VideoPromptPanel</name>
  <files>components/avatar-creator/VideoPromptPanel.tsx</files>
  <action>
Update VideoPromptPanel to fetch and display AI suggestions.

Changes:
1. Import useAISuggestions hook
2. Call hook with imageId:
   ```typescript
   const { data: aiSuggestions, isLoading: isLoadingAI } = useAISuggestions(imageId)
   ```

3. Pass AI data to ActionSuggestions component:
   ```typescript
   <ActionSuggestions
     selectedSuggestions={selectedSuggestions}
     onToggle={handleSuggestionToggle}
     aiSuggestions={aiSuggestions}
     isLoadingAI={isLoadingAI}
     disabled={generateMutation.isPending}
   />
   ```

4. No other changes needed - selection logic already handles arbitrary strings.
  </action>
  <verify>
    - npm run build passes
    - npm run lint passes (only pre-existing warnings)
    - useAISuggestions imported and called
    - AI suggestions passed to ActionSuggestions component
    - AI suggestions can be selected and appear in instruction
  </verify>
  <done>
VideoPromptPanel fetches AI suggestions and passes them to ActionSuggestions for display
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Lint passes: `npm run lint`
3. Functional test:
   - Open panel on an image
   - Fixed suggestions appear immediately
   - AI suggestions section shows loading skeletons
   - After load, 3-5 AI suggestions appear with sparkle icons
   - Click AI suggestion → adds to textarea
   - Generate → instruction includes selected AI suggestion
</verification>

<success_criteria>
- AI suggestions generated by Gemini based on image analysis
- Suggestions displayed with sparkle icon distinction
- Loading state provides feedback during analysis
- AI suggestions function identically to fixed suggestions for selection
- Non-blocking errors (empty array returned, no UI crash)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-suggestions-quality-feedback/08-02-SUMMARY.md`
</output>
