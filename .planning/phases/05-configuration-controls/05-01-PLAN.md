---
phase: 05-configuration-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/avatar-creator/VideoPromptConfig.tsx
  - components/avatar-creator/VideoPromptPanel.tsx
  - hooks/use-generate-video-prompt.ts
autonomous: true

must_haves:
  truths:
    - "User sees 6 camera style chips in panel (Cinematic, Slow Motion, Zoom-In, Orbit, Dolly, Statisch)"
    - "User sees 5 film effect chips in panel (Dramatisch, Weich, Golden Hour, Noir, Vertraumt)"
    - "Clicking a chip selects it (filled background), clicking again deselects"
    - "Clicking 'Video-Prompt erstellen' generates prompt with selected options"
    - "Button shows spinner and disables during generation"
    - "Generated prompt appears in panel after completion"
  artifacts:
    - path: "components/avatar-creator/VideoPromptConfig.tsx"
      provides: "Configuration chips UI for camera style and film effect"
      exports: ["VideoPromptConfig"]
    - path: "hooks/use-generate-video-prompt.ts"
      provides: "React Query mutation for video prompt generation"
      exports: ["useGenerateVideoPrompt"]
    - path: "components/avatar-creator/VideoPromptPanel.tsx"
      provides: "Updated panel with config controls and generation"
      contains: "VideoPromptConfig"
  key_links:
    - from: "VideoPromptConfig.tsx"
      to: "lib/video-prompt-schemas.ts"
      via: "imports CAMERA_STYLES, FILM_EFFECTS constants"
      pattern: "CAMERA_STYLES|FILM_EFFECTS"
    - from: "use-generate-video-prompt.ts"
      to: "app/actions/video-prompt-actions.ts"
      via: "calls generateVideoPromptAction"
      pattern: "generateVideoPromptAction"
    - from: "VideoPromptPanel.tsx"
      to: "VideoPromptConfig.tsx"
      via: "renders VideoPromptConfig component"
      pattern: "<VideoPromptConfig"
---

<objective>
Add configuration controls and generation capability to the video prompt panel.

Purpose: Enable users to select camera style and film effects, then generate video prompts that incorporate these selections.

Output: Updated VideoPromptPanel with chip-based configuration controls and working prompt generation.
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-controls/05-CONTEXT.md
@.planning/phases/04-panel-ui-foundation/04-01-SUMMARY.md

# Key source files for implementation
@lib/video-prompt-schemas.ts
@app/actions/video-prompt-actions.ts
@components/avatar-creator/VideoPromptPanel.tsx
@hooks/use-video-prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoPromptConfig component with chip controls</name>
  <files>components/avatar-creator/VideoPromptConfig.tsx</files>
  <action>
Create a new component `VideoPromptConfig.tsx` that displays camera style and film effect selection chips.

**Component interface:**
```typescript
interface VideoPromptConfigProps {
  selectedCameraStyle: CameraStyleType | null
  selectedFilmEffect: FilmEffectType | null
  onCameraStyleChange: (style: CameraStyleType | null) => void
  onFilmEffectChange: (effect: FilmEffectType | null) => void
  disabled?: boolean
}
```

**Layout (from CONTEXT.md):**
- Stacked vertically: camera style section above film effect section
- Section headers: "Kamerastil" and "Filmeffekt" (small, muted text - text-xs text-gray-500)
- Gap between sections: space-y-6

**Camera style chips:**
- Import CAMERA_STYLES from `@/lib/video-prompt-schemas`
- German labels mapping (same as in server action):
  - cinematic -> "Cinematic"
  - slow_motion -> "Slow Motion"
  - zoom_in -> "Zoom-In"
  - orbit -> "Orbit"
  - dolly -> "Dolly"
  - static -> "Statisch"
- Chips wrap to multiple lines (flex flex-wrap gap-2)

**Film effect chips:**
- Import FILM_EFFECTS from `@/lib/video-prompt-schemas`
- German labels mapping:
  - dramatic -> "Dramatisch"
  - soft -> "Weich"
  - golden_hour -> "Golden Hour"
  - noir -> "Noir"
  - dreamy -> "Vertraumt"

**Chip styling:**
- Use Button component with conditional styling
- Selected state: bg-purple-500/20 border-purple-500 text-purple-400
- Unselected state: bg-transparent border-white/10 text-gray-400 hover:border-white/20
- Rounded pills: rounded-full px-3 py-1 h-auto text-xs
- Clicking selected chip deselects it (toggle behavior)

**Disabled state:**
- When disabled=true, chips have opacity-50 and pointer-events-none
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
VideoPromptConfig component exists with chip controls for camera style (6 options) and film effect (5 options), using German labels and toggle selection behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useGenerateVideoPrompt mutation hook</name>
  <files>hooks/use-generate-video-prompt.ts</files>
  <action>
Create a React Query mutation hook that wraps `generateVideoPromptAction`.

**Hook implementation:**
```typescript
import { useMutation, useQueryClient } from "@tanstack/react-query"
import { generateVideoPromptAction } from "@/app/actions/video-prompt-actions"
import { VideoPromptGenerationConfig } from "@/lib/video-prompt-schemas"

export function useGenerateVideoPrompt() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: (config: VideoPromptGenerationConfig) =>
      generateVideoPromptAction(config),
    onSuccess: (data, variables) => {
      // Invalidate video prompts query to refetch with new prompt
      queryClient.invalidateQueries({
        queryKey: ['video-prompts', variables.imageId]
      })
    },
  })
}
```

**Key behaviors:**
- Accepts VideoPromptGenerationConfig (imageId, cameraStyle, filmEffects, userInstruction)
- On success, invalidates the video-prompts query for that imageId
- Returns standard mutation object (mutate, isPending, error, etc.)
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
useGenerateVideoPrompt hook exists and correctly invalidates video-prompts query on success.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate config and generation into VideoPromptPanel</name>
  <files>components/avatar-creator/VideoPromptPanel.tsx</files>
  <action>
Update VideoPromptPanel to include configuration controls and generation capability.

**Add imports:**
```typescript
import { VideoPromptConfig } from "@/components/avatar-creator/VideoPromptConfig"
import { useGenerateVideoPrompt } from "@/hooks/use-generate-video-prompt"
import { CameraStyleType, FilmEffectType } from "@/lib/video-prompt-schemas"
import { Loader2 } from "lucide-react"
import { toast } from "sonner"
```

**Add state for selections (with defaults from CONTEXT.md):**
```typescript
const [selectedCameraStyle, setSelectedCameraStyle] = useState<CameraStyleType | null>("cinematic")
const [selectedFilmEffect, setSelectedFilmEffect] = useState<FilmEffectType | null>("soft")
```

**Add mutation hook:**
```typescript
const generateMutation = useGenerateVideoPrompt()
```

**Add generate handler:**
```typescript
const handleGenerate = () => {
  if (!imageId) return

  generateMutation.mutate({
    imageId,
    cameraStyle: selectedCameraStyle || "static",
    filmEffects: selectedFilmEffect ? [selectedFilmEffect] : [],
  }, {
    onSuccess: () => {
      toast.success("Video-Prompt erstellt!")
    },
    onError: (error) => {
      toast.error("Fehler beim Erstellen", {
        description: error instanceof Error ? error.message : "Unbekannter Fehler"
      })
    }
  })
}
```

**Update empty state section:**
Replace the existing empty state (lines 51-70) with configuration controls:
```tsx
{!isLoading && !error && !currentPrompt && (
  <div className="space-y-6">
    <VideoPromptConfig
      selectedCameraStyle={selectedCameraStyle}
      selectedFilmEffect={selectedFilmEffect}
      onCameraStyleChange={setSelectedCameraStyle}
      onFilmEffectChange={setSelectedFilmEffect}
      disabled={generateMutation.isPending}
    />
    <Button
      onClick={handleGenerate}
      disabled={generateMutation.isPending}
      className="w-full bg-purple-600 hover:bg-purple-700 text-white"
    >
      {generateMutation.isPending ? (
        <>
          <Loader2 className="h-4 w-4 animate-spin mr-2" />
          Generiere...
        </>
      ) : (
        "Video-Prompt erstellen"
      )}
    </Button>
  </div>
)}
```

**Update content state section:**
Add config controls above the prompt display in content state too (for regeneration):
```tsx
{!isLoading && !error && currentPrompt && (
  <div className="space-y-6">
    {/* Config controls for regeneration */}
    <VideoPromptConfig
      selectedCameraStyle={selectedCameraStyle}
      selectedFilmEffect={selectedFilmEffect}
      onCameraStyleChange={setSelectedCameraStyle}
      onFilmEffectChange={setSelectedFilmEffect}
      disabled={generateMutation.isPending}
    />
    <Button
      onClick={handleGenerate}
      disabled={generateMutation.isPending}
      variant="outline"
      className="w-full border-purple-500/50 text-purple-400 hover:bg-purple-500/10"
    >
      {generateMutation.isPending ? (
        <>
          <Loader2 className="h-4 w-4 animate-spin mr-2" />
          Generiere neu...
        </>
      ) : (
        "Neuen Prompt erstellen"
      )}
    </Button>

    {/* Existing prompt display */}
    <div className="bg-white/5 rounded-lg p-4 border border-white/10">
      <p className="text-sm text-gray-200 whitespace-pre-wrap leading-relaxed">
        {currentPrompt.prompt_text}
      </p>
    </div>

    {/* Metadata */}
    <div className="flex items-center gap-2 text-xs text-gray-500">
      <span>Erstellt: {new Date(currentPrompt.created_at).toLocaleDateString('de-DE')}</span>
      {currentPrompt.camera_style && (
        <>
          <span>-</span>
          <span className="capitalize">{currentPrompt.camera_style.replace('_', ' ')}</span>
        </>
      )}
    </div>
  </div>
)}
```

**Remove footer placeholder:**
Remove the disabled "Kopieren (Phase 6)" button from footer - Phase 6 will add the real copy functionality. Keep the footer structure but leave it empty for now, or remove it entirely if not needed.
  </action>
  <verify>
1. TypeScript compiles:
```bash
npx tsc --noEmit
```

2. Build succeeds:
```bash
npm run build
```
  </verify>
  <done>
VideoPromptPanel displays camera style and film effect chips with defaults (Cinematic, Weich). Generate button triggers prompt creation with loading state. After generation, prompt appears in panel.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```

2. **Build verification:**
   ```bash
   npm run build
   ```

3. **Manual verification checklist (for user testing):**
   - Open image gallery and click video button on an image
   - Panel opens showing 6 camera style chips (Cinematic pre-selected)
   - Panel shows 5 film effect chips (Weich pre-selected)
   - Clicking a chip selects it (purple highlight)
   - Clicking selected chip deselects it
   - Click "Video-Prompt erstellen" button
   - Button shows spinner and "Generiere..." text
   - After completion, prompt text appears in panel
   - Badge indicator on video button updates to show prompt exists
</verification>

<success_criteria>
Phase 5 is complete when:
1. Panel displays 6 camera style options as selectable chips
2. Panel displays 5 film effect options as selectable chips
3. Chips toggle between selected/unselected states visually
4. Generate button triggers video prompt creation via server action
5. Generated prompts include selected camera style and film effect
6. UI shows loading state during generation
7. All TypeScript compiles without errors
8. Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-controls/05-01-SUMMARY.md`
</output>
