---
phase: 01-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/YYYYMMDDHHMMSS_create_video_prompts_table.sql
  - types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "video_prompts table exists with all required fields"
    - "Users can only access their own video prompts"
    - "Deleting an image cascades to delete associated video prompts"
    - "Multiple variants per image are stored with timestamp ordering"
  artifacts:
    - path: "supabase/migrations/YYYYMMDDHHMMSS_create_video_prompts_table.sql"
      provides: "Video prompts table DDL with RLS policies"
      contains: "create table public.video_prompts"
    - path: "types/database.types.ts"
      provides: "TypeScript types for video_prompts"
      contains: "video_prompts"
  key_links:
    - from: "video_prompts.image_id"
      to: "images.id"
      via: "foreign key with ON DELETE CASCADE"
      pattern: "references public.images.*on delete cascade"
---

<objective>
Create the video_prompts table with user ownership, variant tracking, and cascading deletes.

Purpose: Database foundation for storing AI-generated video prompts linked to images
Output: Migration file with table DDL, RLS policies, and updated TypeScript types
</objective>

<execution_context>
@/Users/cweissteiner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cweissteiner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-CONTEXT.md
@supabase/migrations/20260105152700_create_image_generation_tables.sql
@types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video_prompts table with foreign key CASCADE</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_create_video_prompts_table.sql</files>
  <action>
Create a new migration file with timestamp-based naming (use current timestamp in format YYYYMMDDHHMMSS).

Create the `video_prompts` table with these columns:
- `id` uuid primary key default gen_random_uuid()
- `image_id` uuid not null references public.images(id) on delete cascade
- `user_id` uuid not null references auth.users(id) on delete cascade
- `prompt_text` text not null check (char_length(prompt_text) <= 2000)
- `user_instruction` text (optional, stores original user input)
- `model_name` text not null (which Gemini model generated this)
- `camera_style` text default 'statisch'
- `film_effects` text[] default '{}'::text[] (array for multi-select)
- `status` text not null default 'draft' check (status in ('draft', 'pending', 'completed', 'failed'))
- `is_primary` boolean default false
- `error_code` text
- `error_message` text
- `created_at` timestamptz not null default now()
- `updated_at` timestamptz not null default now()

Add indexes:
- Index on (image_id) for fetching prompts by image
- Index on (user_id) for fetching user's prompts
- Index on (image_id, created_at) for ordered variant listing

Add updated_at trigger using existing pattern or create if needed:
```sql
create or replace function update_updated_at_column()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

create trigger update_video_prompts_updated_at
  before update on public.video_prompts
  for each row execute function update_updated_at_column();
```
  </action>
  <verify>
Run `npm run db:push` to apply migration. Check Supabase dashboard or run SQL query to confirm table exists with all columns.
  </verify>
  <done>
video_prompts table exists with all specified columns, indexes, CASCADE constraint on image_id, and updated_at trigger.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RLS policies for user ownership</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_create_video_prompts_table.sql</files>
  <action>
In the same migration file, enable RLS and create policies:

```sql
-- Enable RLS
alter table public.video_prompts enable row level security;

-- Users can view their own video prompts
create policy "Users can view own video prompts"
  on public.video_prompts for select
  using (auth.uid() = user_id);

-- Users can insert their own video prompts
create policy "Users can insert own video prompts"
  on public.video_prompts for insert
  with check (auth.uid() = user_id);

-- Users can update their own video prompts
create policy "Users can update own video prompts"
  on public.video_prompts for update
  using (auth.uid() = user_id)
  with check (auth.uid() = user_id);

-- Users can delete their own video prompts
create policy "Users can delete own video prompts"
  on public.video_prompts for delete
  using (auth.uid() = user_id);
```

Then regenerate TypeScript types:
```bash
npm run types:update
```
  </action>
  <verify>
1. Check migration file contains all 4 RLS policies (select, insert, update, delete)
2. Run `npm run types:update` successfully
3. Verify types/database.types.ts contains video_prompts table definition
  </verify>
  <done>
RLS enabled on video_prompts with 4 policies (select, insert, update, delete) restricting access to owner. TypeScript types regenerated to include video_prompts.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists in supabase/migrations/ with correct naming
2. Table creation SQL includes all columns from CONTEXT.md decisions:
   - prompt_text with 2000 char limit
   - user_instruction field
   - model_name field
   - camera_style with 'statisch' default
   - film_effects as text array
   - status with check constraint (draft, pending, completed, failed)
   - is_primary boolean
   - error_code and error_message
   - timestamps
3. Foreign key to images with ON DELETE CASCADE exists
4. RLS enabled with 4 policies
5. Indexes on image_id, user_id, and (image_id, created_at)
6. TypeScript types updated in types/database.types.ts
7. `npm run db:push` applies migration without errors
</verification>

<success_criteria>
- video_prompts table exists in Supabase
- Deleting an image row cascades to delete its video_prompts
- RLS prevents cross-user access (tested by checking policies exist)
- TypeScript types include video_prompts with all fields typed
- Multiple variants can be inserted for the same image_id
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-01-SUMMARY.md`
</output>
