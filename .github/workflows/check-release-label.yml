name: Check Release Label

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  pull-requests: write
  contents: read

jobs:
  check-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Check for release labels
        id: check_labels
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const { data: pullRequest } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: number,
            });

            const labels = pullRequest.labels.map(label => label.name);
            const releaseLabels = ['major', 'minor', 'patch'];
            const hasReleaseLabel = labels.some(label => releaseLabels.includes(label));
            
            console.log(`Current labels: ${labels.join(', ')}`);

            if (hasReleaseLabel) {
              console.log('Release label found.');
              return { hasLabel: true };
            }
            
            console.log('No release label found. Checking for version bump...');
            return { hasLabel: false };

      - name: Checkout code
        if: fromJson(steps.check_labels.outputs.result).hasLabel == false
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bump and apply label
        if: fromJson(steps.check_labels.outputs.result).hasLabel == false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current version
          NEW_VERSION=$(node -p "require('./package.json').version")
          
          # Get base version (from the branch we are merging into)
          git checkout origin/${{ github.base_ref }} package.json
          OLD_VERSION=$(node -p "require('./package.json').version")
          
          echo "Old Version: $OLD_VERSION"
          echo "New Version: $NEW_VERSION"
          
          if [ "$OLD_VERSION" == "$NEW_VERSION" ]; then
            echo "Version has not changed. Please add a major, minor, or patch label manually."
            exit 1
          fi
          
          # Split versions into parts
          IFS='.' read -r -a OLD_PARTS <<< "$OLD_VERSION"
          IFS='.' read -r -a NEW_PARTS <<< "$NEW_VERSION"
          
          LABEL=""
          
          if [ "${OLD_PARTS[0]}" != "${NEW_PARTS[0]}" ]; then
            LABEL="major"
          elif [ "${OLD_PARTS[1]}" != "${NEW_PARTS[1]}" ]; then
            LABEL="minor"
          elif [ "${OLD_PARTS[2]}" != "${NEW_PARTS[2]}" ]; then
            LABEL="patch"
          else
             echo "Version parts identical? Something went wrong."
             exit 1
          fi
          
          echo "Detected $LABEL bump."
          
          # Apply label
          gh pr edit ${{ github.event.pull_request.number }} --add-label "$LABEL"
          echo "Applied label: $LABEL"
